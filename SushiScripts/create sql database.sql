CREATE DATABASE SushiDB
/*
USE MASTER;
ALTER DATABASE SushiDB SET SINGLE_USER WITH ROLLBACK IMMEDIATE;
DROP DATABASE SushiDB;
*/

GO
USE SushiDB
GO

CREATE TABLE TEMP_CART (
    MACTMON CHAR(10),
	MAKH CHAR(10),
	SELECTED BIT DEFAULT 0,

	CONSTRAINT PK_TEMP_CART
    PRIMARY KEY (MACTMON, MAKH)
);

CREATE TABLE ACCOUNT
(
	ID INT PRIMARY KEY IDENTITY,
	USERNAME NVARCHAR(20) NOT NULL UNIQUE,
	[PASSWORD] NVARCHAR(MAX) NOT NULL,
	[ROLE] NVARCHAR(20) NOT NULL CHECK (ROLE IN (N'Customer', N'Staff', N'Admin', N'Branch Manager', N'Department Manager')),
)

ALTER TABLE KHACHHANG
ADD ACCOUNT_ID INT

ALTER TABLE NHANVIEN
ADD ACCOUNT_ID INT

ALTER TABLE MONAN
ADD IMAGE_LINK NVARCHAR(MAX)

ALTER TABLE COMBOMONAN
ADD IMAGE_LINK NVARCHAR(MAX)


-- Hoá đơn định danh bởi mã hoá đơn
CREATE TABLE HOADON
(
    MAHOADON CHAR(10),
    GIOLAP TIME NOT NULL,
    NGAYLAP DATE NOT NULL,
    VAT FLOAT DEFAULT 0.08,
    TIENKHACHDUA FLOAT NOT NULL,
    TRANGTHAI NVARCHAR(20) NOT NULL CHECK (TRANGTHAI IN (N'Unpaid', N'Paid', N'Cancelled')),
    PHUONGTHUC NVARCHAR(20) NOT NULL CHECK (PHUONGTHUC IN (N'Bank transfer', N'Cash', N'Credit card')),
    MAKHACHHANG CHAR(10),
	MACHINHANH CHAR(10),
	TONGTIENTRUOCKM FLOAT, -- Thuộc tính suy diễn từ THANHTIEN(DONDATMON), VAT(HOADON) từ các HOADONLIENQUAN (DONDATMON) có TRANGTHAI (DONDATMON) thành công
						   -- TONGTIENTRUOCKM = SUM(THANHTIEN) x (1 + VAT)
	TONGTIENSAUKM FLOAT, -- Thuộc tính suy diễn từ TONGTIENTRUOCKM (HOADON), LUONGKMPHANTRAM (KHUYENMAITHETHANHVIEN), LUONGKMTIEN (KHUYENMAIKHACHHANG)
						 -- TONGTIENSAUKM = (TONGTIENTRUOCKM - LUONGTIENKM) x (1 - LUONGKMPHANTRAM)
	
	CONSTRAINT PK_HOADON
    PRIMARY KEY (MAHOADON)
)

-- Đơn đặt món định danh bởi mã đơn
-- Đơn đặt món chứa các món được đặt và có thể có nhiều đơn đặt món trong hoá đơn
CREATE TABLE DONDATMON
(
    MADON CHAR(10),
    GIODAT TIME NOT NULL,
    NGAYDAT DATE NOT NULL,
    TRANGTHAI NVARCHAR(20) NOT NULL CHECK (TRANGTHAI IN (N'Unconfirmed', N'Processing', N'Successful', N'Paid')),
    LOAIDONDATMON NVARCHAR(20) NOT NULL CHECK (LOAIDONDATMON IN (N'Online order', N'In-store order')),
    HOADONLIENQUAN CHAR(10),
    KHACHHANGDAT CHAR(10),
    MADATCHO CHAR(10),
    CHINHANHDAT CHAR(10) NOT NULL, 
    NHANVIENTAOLAP CHAR(10),
	THANHTIEN FLOAT,	-- Thuộc tính suy diễn từ DONGIATONG (CHITIETMONAN)
						-- THANHTIEN = SUM(DONGIATONG)
	
    CONSTRAINT PK_DONDATMON
    PRIMARY KEY (MADON)
)

-- Đặt hàng trực tuyến định danh bởi mã đơn hàng trực tuyến
-- Đặt hàng trực tuyến là con của đơn đặt món
CREATE TABLE DATHANGTRUCTUYEN
(
    MADHTRUCTUYEN CHAR(10),
    THOIGIANGIAO TIME NOT NULL,
    DIACHIGIAO NVARCHAR(100) NOT NULL,
    TRANGTHAIGIAO NVARCHAR(20) NOT NULL CHECK (TRANGTHAIGIAO IN (N'Processing', N'Delivered', N'Cancelled')),

    CONSTRAINT PK_DATHANGTRUCTUYEN
    PRIMARY KEY (MADHTRUCTUYEN)
)

-- Đặt hàng tại chỗ định danh bởi mã đơn hàng tại chỗ
-- Đặt hàng tại chỗ là con của đơn đặt món
CREATE TABLE DATHANGTAICHO
(
    MADHTAICHO CHAR(10),
    MACHINHANH CHAR(10),
    SOBAN VARCHAR(3),

    CONSTRAINT PK_DATHANGTAICHO
    PRIMARY KEY (MADHTAICHO)
)

-- Chi nhánh định danh bởi mã chi nhánh
CREATE TABLE CHINHANH
(
	MACHINHANH CHAR(10),
	TENCHINHANH NVARCHAR(50) NOT NULL,
	DIACHI NVARCHAR(100) NOT NULL,
	KHUVUC NVARCHAR(50) NOT NULL CHECK (KHUVUC IN (N'District 1', N'District 2', N'District 3', 
        N'District 4', N'District 5', N'District 6', N'District 7', N'District 8', N'District 9',
        N'District 10', N'District 11', N'District 12', N'Go Vap District', N'Phu Nhuan District', 
        N'Binh Thanh District', N'Tan Binh District', N'Tan Phu District', N'Binh Tan District', 
        N'Binh Chanh District', N'Cu Chi District', N'Hoc Mon District', N'Nha Be District', N'Can Gio District')),
	THOIGIANMOCUA TIME NOT NULL,
	THOIGIANDONGCUA TIME NOT NULL,
	SDT CHAR(10),
	EMAIL VARCHAR(100),
	COBAIDOXE BIT NOT NULL,
	NHANVIENQUANLY CHAR(10),
	
	CONSTRAINT PK_CHINHANH
	PRIMARY KEY (MACHINHANH)
)

-- Bàn ăn được định danh bởi số bàn và mã chi nhánh bàn ăn đặt ở
CREATE TABLE BANAN
(
	SOBAN VARCHAR(3) CHECK (SOBAN NOT LIKE '%[^0-9]%'),
	MACHINHANH CHAR(10),
	VITRI NVARCHAR(50),
	TRANGTHAI NVARCHAR(20) NOT NULL CHECK (TRANGTHAI IN (N'Available', N'Reserved', N'In use', N'Unavailable')),
	SONGUOITOIDA INT NOT NULL,

	CONSTRAINT PK_BANAN
	PRIMARY KEY (SOBAN, MACHINHANH)
)

-- Đặt chỗ định danh bởi mã đặt chỗ
CREATE TABLE DATCHO
(
	MADATCHO CHAR(10),
	NGAYDEN DATE NOT NULL,
	GIODEN TIME NOT NULL,
	SOLUONGKHACH INT NOT NULL,

	GHICHU NVARCHAR(MAX),
	SDT CHAR(10) NOT NULL,

	CONSTRAINT PK_DATCHO
	PRIMARY KEY (MADATCHO)
)

-- Chi tiết đặt chỗ định danh bởi số bàn, mã chi nhánh liên quan, và mã đặt chỗ
CREATE TABLE CHITIETDATCHO
(
	SOBAN VARCHAR(3),
	MACHINHANH CHAR(10),
	MADATCHO CHAR(10),
	SOLUONGKHACH INT,

	CONSTRAINT PK_CHITIETDATCHO
	PRIMARY KEY (SOBAN, MACHINHANH, MADATCHO)
)

-- Nhân viên định danh bởi mã nhân viên
CREATE TABLE NHANVIEN
(
	MANHANVIEN CHAR(10),
	HOTEN NVARCHAR(50) NOT NULL,
	NGAYSINH DATE NOT NULL,
	GIOITINH NVARCHAR(6) NOT NULL CHECK (GIOITINH IN ('MALE','FEMALE')),
	SDT CHAR(10),
	EMAIL VARCHAR(100),
	DIACHI NVARCHAR(100) NOT NULL,
	CHINHANHLAMVIEC CHAR(10),
	LUONGHIENTAI FLOAT, -- Thuộc tính suy diễn từ LUONG (BOPHAN) và HESOLUONG (LICHSULAMVIEC) của công việc gần nhất
						-- LUONGHIENTAI = LUONG * HESOLUONG
	
	CONSTRAINT PK_NHANVIEN
	PRIMARY KEY (MANHANVIEN)
)

-- Bộ phận định danh bởi mã bộ phận và có thể có nhiều nhân viên
-- lương nhân viên cùng bộ phận tương đối giống nhau
CREATE TABLE BOPHAN
(
	MABOPHAN CHAR(10),
	MACHINHANH CHAR(10),
	TENBOPHAN NVARCHAR(50) NOT NULL,
	LUONG FLOAT NOT NULL,
	QUANLYBOPHAN CHAR(10),

	CONSTRAINT PK_BOPHAN
	PRIMARY KEY (MABOPHAN, MACHINHANH)
)

-- Lịch sử làm việc định danh bởi mã nhân viên, mã bộ phận, và mã chi nhánh làm việc
-- Lịch sử làm việc lưu lại ngày làm, ngày nghỉ, hệ số lương trong khoảng đó của nhân viên
CREATE TABLE LICHSULAMVIEC
(
	MANHANVIEN CHAR(10),
	MABOPHAN CHAR(10),
	MACHINHANH CHAR(10),
	NGAYVAOLAM DATE NOT NULL,
	NGAYNGHIVIEC DATE,
	HESOLUONG FLOAT NOT NULL,

	CONSTRAINT PK_LICHSULAMVIEC
	PRIMARY KEY (MANHANVIEN, MABOPHAN, MACHINHANH)
)

-- Khách hàng định danh bởi mã khách hàng
CREATE TABLE KHACHHANG
(
	MAKHACHHANG CHAR(10),
	HOTEN NVARCHAR(50) NOT NULL,
	SDT CHAR(10),
	EMAIL VARCHAR(100),
	CCCD VARCHAR(20) CHECK (CCCD NOT LIKE '%[^0-9]%'),

	CONSTRAINT PK_KHACHHANNG
	PRIMARY KEY (MAKHACHHANG)
)

-- Đánh giá định danh bởi mã đánh giá
CREATE TABLE DANHGIA
(
	MADANHGIA CHAR(10),
	DIEMPHUCVU INT NOT NULL CHECK (DIEMPHUCVU BETWEEN 1 AND 5),
	DIEMVITRICHINHANH INT NOT NULL CHECK (DIEMVITRICHINHANH BETWEEN 1 AND 5),
	DIEMKHONGGIAN INT NOT NULL CHECK (DIEMKHONGGIAN BETWEEN 1 AND 5),
	BINHLUAN NVARCHAR(MAX),
	KHACHHANGDANHGIA CHAR(10),
	CHINHANH CHAR(10) NOT NULL,
	NHANVIEN CHAR(10),
	MADON CHAR(10),

	CONSTRAINT PK_DANHGIA
	PRIMARY KEY (MADANHGIA)
)

-- Thẻ thành viên định danh bởi mã thẻ
-- Thẻ thành viên chỉ có 3 bản ghi tương ứng với thông tin của 3 phân hạng là Membership, Silver, Gold.
CREATE TABLE THETHANHVIEN
(
	MATHE CHAR(10),
	LOAITHE NVARCHAR(50) NOT NULL CHECK (LOAITHE IN (N'Membership', N'Silver', N'Gold')),

	CONSTRAINT PK_THETHANHVIEN
	PRIMARY KEY (MATHE)
)

-- Chi tiết khách hàng định danh bởi mã khách hàng và mã thẻ
-- Chi tiết khách hàng chứa những thông tin khách hàng liên quan
CREATE TABLE CHITIETKHACHHANG
(
	MAKHACHHANG CHAR(10),
	MATHE CHAR(10),
	NGAYDK DATE NOT NULL,
	DIEMTICHLUY INT NOT NULL CHECK (DIEMTICHLUY >= 0),
	NGAYNANGHANG DATE NOT NULL,
	TRANGTHAITAIKHOAN NVARCHAR(50) NOT NULL CHECK (TRANGTHAITAIKHOAN IN (N'Active', N'Deleted', N'Inactive')), -- N'Hoạt động', N'Đã xoá', N'Tạm dừng'
	NHANVIENTAOLAP CHAR(10) NOT NULL,

	CONSTRAINT PK_CHITIETKHACHHAHG
	PRIMARY KEY (MAKHACHHANG, MATHE)
)

-- Đánh giá món ăn định danh bởi mã đánh giá liên quan và mã món ăn đó
CREATE TABLE DANHGIAMONAN
(
	MADANHGIA CHAR(10),
	MAMON CHAR(10),
	DIEMCHATLUONGMONAN INT NOT NULL CHECK (DIEMCHATLUONGMONAN BETWEEN 1 AND 5),
	DIEMGIACA INT NOT NULL CHECK (DIEMGIACA BETWEEN 1 AND 5),

	CONSTRAINT PK_DANHGIAMONAN
	PRIMARY KEY (MADANHGIA, MAMON)
)

-- Truy cập định danh bởi mã truy cập và mã đánh giá liên quan
CREATE TABLE TRUYCAP
(
	MATRUYCAP CHAR(10),
	MADHTRUCTUYEN CHAR(10),
	THOIDIEMBATDAU DATE NOT NULL,
	THOIDIEMKETTHUC DATE NOT NULL,

	CONSTRAINT PK_TRUYCAP
	PRIMARY KEY (MATRUYCAP, MADHTRUCTUYEN)
)

-- Món ăn định nghĩa bởi mã món
CREATE TABLE MONAN
(
	MAMON CHAR(10),
	TENMON NVARCHAR(50) NOT NULL,
	DANHMUC NVARCHAR(50) NOT NULL,

	CONSTRAINT PK_MONAN
	PRIMARY KEY (MAMON)
)

-- Combo món ăn định danh bởi mã combo
-- Combo món ăn có thể chứa nhiều món ăn
CREATE TABLE COMBOMONAN
(
	MACOMBO CHAR(10),
	TENCOMBO NVARCHAR(50) NOT NULL,
	MOTACOMBO NVARCHAR(MAX),

	CONSTRAINT PK_COMBOMONAN
	PRIMARY KEY (MACOMBO)
)

-- Chi tiết món ăn định danh bởi mã chi tiết món
-- Chi tiết món ăn định nghĩa rõ ràng một order trong một đơn đặt món
CREATE TABLE CHITIETMONAN
(
	MACTMON CHAR(10),
	MAMENU CHAR(10),
	SOLUONG INT NOT NULL,
	GHICHU NVARCHAR(MAX),
	DONGIATONG FLOAT, -- Thuộc tính suy diễn từ SOLUONG (CHITIETMONAN) và GIAHIENTAI (MONAN)/DONGIACOMBO (COMBO)
					  -- DONGIATONG = SOLUONG * GIAHIENTAI/DONGIACOMBO
	MADONDATMON CHAR(10),

	CONSTRAINT PK_CHITIETMONAN
	PRIMARY KEY (MACTMON)
)

-- Món ăn - Combo món ăn định danh bởi mã combo và mã món ăn liên quan
-- Món ăn - Combo món ăn đề ra một combo có những món ăn nào
CREATE TABLE MONAN_COMBOMONAN
(
	MACOMBO CHAR(10),
	MAMON CHAR(10),
	SOLUONG INT NOT NULL,

	CONSTRAINT PK_MONAN_COMBOMONAN
	PRIMARY KEY (MACOMBO, MAMON)
)

-- Khuyến mãi định danh bởi mã khuyến mãi
CREATE TABLE KHUYENMAI
(
	MAKHUYENMAI CHAR(10),
	THONGTINKHUYENMAI NVARCHAR(MAX),
	LOAIKHUYENMAI NVARCHAR(20) NOT NULL check(loaikhuyenmai in (N'Membership card', N'Customer')),

	CONSTRAINT PK_KHUYENMAI
	PRIMARY KEY (MAKHUYENMAI)
)

-- Khuyến mãi khách hàng định danh bởi mã khuyến mãi
-- Khuyến mãi khách hàng là con của khuyến mãi
-- Khuyến mãi khách hàng dành riêng cho mỗi khách hàng và tính bằng tiền
CREATE TABLE KHUYENMAIKHACHHANG
(
	MAKHUYENMAI CHAR(10),
	TRANGTHAIDUNG BIT NOT NULL,
	MAKHACHHANG CHAR(10),
	NGAYBATDAU DATE NOT NULL,
	NGAYKETTHUC DATE NOT NULL,
	GIATRITOITHIEU FLOAT NOT NULL,
	LUONGKMTIEN FLOAT NOT NULL,

	CONSTRAINT PK_KHUYENMAIKHACHHANG
	PRIMARY KEY (MAKHUYENMAI)
)

-- Khuyến mãi thẻ thành viên định danh bởi mã khuyến mãi
-- Khuyến mãi thẻ thành viên là con của khuyến mãi
-- Khuyến mãi thẻ thành viên tự động áp dụng cho các khách hàng thuộc mã thẻ loại SILVER, GOLD theo %
CREATE TABLE KHUYENMAITHETHANHVIEN
(
	MAKHUYENMAI CHAR(10),
	MATHE CHAR(10),
	LUONGKMPHANTRAM FLOAT NOT NULL,

	CONSTRAINT PK_KHUYENMAITHETHANHVIEN
	PRIMARY KEY (MAKHUYENMAI)
)

-- Menu định danh bởi mã menu
-- Menu chứa thông tin của một món ăn hoặc một combo
-- Menu khẳng định những thông tin món hoặc combo ở những chi nhánh khác nhau
-- Menu có thể chứa cùng một món ăn hoặc combo nhưng khác giá và trạng thái ở các chi nhánh 
CREATE TABLE MENU 
(
	MAMENU CHAR(10),
	MACHINHANH CHAR(10),
	MAMON CHAR(10),			-- Mã món có giá trị thì mã menu phải null
	MACOMBO CHAR(10),		-- Mã menu có giá trị thì mã món phải null
	GIAHIENTAI FLOAT,		-- Giá hiện tại của món ăn sẽ tương đối giống nhau tuỳ vào chi nhánh
							-- Giá hiện tại của combo sẽ bằng tổng các món ăn trừ đi % giảm giá 
	TRANGTHAIPHUCVU NVARCHAR(20) NOT NULL CHECK (TRANGTHAIPHUCVU IN (N'Available', N'Out of stock', N'Discontinued')),

	CONSTRAINT PK_MENU
	PRIMARY KEY(MAMENU)
)

-- Insert dữ liệu loại thẻ (Membership, Silver, Gold) cho THETHANHVIEN
INSERT INTO THETHANHVIEN(MATHE, LOAITHE)
VALUES ('M', 'Membership')
INSERT INTO THETHANHVIEN(MATHE, LOAITHE)
VALUES ('S', N'Silver')
INSERT INTO THETHANHVIEN(MATHE, LOAITHE)
VALUES ('G', N'Gold')