CREATE DATABASE SushiDB
-- DROP DATABASE SushiDB

GO
USE SushiDB
GO

CREATE TABLE HOADON
(
    MAHOADON CHAR(10),
    GIOLAP TIME NOT NULL,
    NGAYLAP DATE NOT NULL,
    VAT FLOAT DEFAULT 0.08,
    TIENKHACHDUA FLOAT NOT NULL,
    TRANGTHAI NVARCHAR(20) NOT NULL CHECK (TRANGTHAI IN (N'Chưa thanh toán', N'Đã thanh toán', N'Hủy')),
    PHUONGTHUC NVARCHAR(20) NOT NULL CHECK (PHUONGTHUC IN (N'Chuyển khoản', N'Tiền mặt', N'Thẻ tín dụng')),
    MAKHACHHANG CHAR(10),
	MACHINHANH CHAR(10),
	TONGTIENTRUOCKM FLOAT, -- Thuộc tính suy diễn từ THANHTIEN(DONDATMON), VAT(HOADON) từ các HOADONLIENQUAN (DONDATMON) có TRANGTHAI (DONDATMON) thành công
						   -- TONGTIENTRUOCKM = SUM(THANHTIEN) x (1 + VAT)
	TONGTIENSAUKM FLOAT, -- Thuộc tính suy diễn từ TONGTIENTRUOCKM (HOADON), LUONGKMPHANTRAM (KHUYENMAITHETHANHVIEN), LUONGKMTIEN (KHUYENMAIKHACHHANG)
						 -- TONGTIENSAUKM = (TONGTIENTRUOCKM - LUONGTIENKM) x (1 - LUONGKMPHANTRAM)
	
	CONSTRAINT PK_HOADON
    PRIMARY KEY (MAHOADON)
)

CREATE TABLE DONDATMON
(
    MADON CHAR(10),
    GIODAT TIME NOT NULL,
    NGAYDAT DATE NOT NULL,
    TRANGTHAI NVARCHAR(20) NOT NULL CHECK (TRANGTHAI IN (N'Chưa xác nhận', N'Đang xử lý', N'Thành công', N'Đã thanh toán')),
	LOAIDONDATMON NVARCHAR(20) NOT NULL CHECK (LOAIDONDATMON IN (N'Đặt hàng trực tuyến', N'Đặt hàng tại chỗ')),
    HOADONLIENQUAN CHAR(10),
    KHACHHANGDAT CHAR(10),
    MADATCHO CHAR(10) NOT NULL,
    CHINHANHDAT CHAR(10) NOT NULL, 
    NHANVIENTAOLAP CHAR(10),
	THANHTIEN FLOAT,	-- Thuộc tính suy diễn từ DONGIATONG (CHITIETMONAN)
						-- THANHTIEN = SUM(DONGIATONG)
	
    CONSTRAINT PK_DONDATMON
    PRIMARY KEY (MADON)
)

CREATE TABLE DATHANGTRUCTUYEN
(
    MADHTRUCTUYEN CHAR(10),
    THOIGIANGIAO TIME NOT NULL,
    DIACHIGIAO NVARCHAR(100) NOT NULL,
    TRANGTHAIGIAO NVARCHAR(20) NOT NULL CHECK (TRANGTHAIGIAO IN (N'Đang xử lý', N'Đã giao', N'Đã hủy')),

    CONSTRAINT PK_DATHANGTRUCTUYEN
    PRIMARY KEY (MADHTRUCTUYEN)
)

CREATE TABLE DATHANGTAICHO
(
    MADHTAICHO CHAR(10),
    MACHINHANH CHAR(10),
    SOBAN VARCHAR(3),

    CONSTRAINT PK_DATHANGTAICHO
    PRIMARY KEY (MADHTAICHO)
)

CREATE TABLE CHINHANH
(
	MACHINHANH CHAR(10),
	TENCHINHANH NVARCHAR(50) NOT NULL,
	DIACHI NVARCHAR(100) NOT NULL,
	KHUVUC NVARCHAR(50) NOT NULL CHECK (KHUVUC IN (N'Quận 1', N'Quận 2', N'Quận 3', N'Quận 4', N'Quận 5', N'Quận 6', N'Quận 7', N'Quận 8', N'Quận 9', N'Quận 10', N'Quận 11', N'Quận 12', N'Quận Gò Vấp', N'Quận Phú Nhuận', N'Quận Bình Thạnh', N'Quận Tân Bình', N'Quận Tân Phú', N'Quận Bình Tân', N'Huyện Bình Chánh', N'Huyện Củ Chi', N'Huyện Hóc Môn', N'Huyện Nhà Bè', N'Huyện Cần Giờ')),
	THOIGIANMOCUA TIME NOT NULL,
	THOIGIANDONGCUA TIME NOT NULL,
	SDT CHAR(10),
	EMAIL VARCHAR(100),
	COBAIDOXE BIT NOT NULL,
	NHANVIENQUANLY CHAR(10),
	
	CONSTRAINT PK_CHINHANH
	PRIMARY KEY (MACHINHANH)
)

CREATE TABLE BANAN
(
	SOBAN VARCHAR(3) CHECK (SOBAN NOT LIKE '%[^0-9]%'),
	MACHINHANH CHAR(10),
	VITRI NVARCHAR(50),
	TRANGTHAI NVARCHAR(20) NOT NULL CHECK (TRANGTHAI IN (N'Trống', N'Đã đặt', N'Đang sử dụng', N'Không khả dụng')),
	SONGUOITOIDA INT NOT NULL,

	CONSTRAINT PK_BANAN
	PRIMARY KEY (SOBAN, MACHINHANH)
)

CREATE TABLE DATCHO
(
	MADATCHO CHAR(10),
	NGAYDEN DATE NOT NULL,
	GIODEN TIME NOT NULL,
	SOLUONGKHACH INT NOT NULL,

	GHICHU NVARCHAR(MAX),
	SDT CHAR(10) NOT NULL,

	CONSTRAINT PK_DATCHO
	PRIMARY KEY (MADATCHO)
)

CREATE TABLE CHITIETDATCHO
(
	SOBAN VARCHAR(3),
	MACHINHANH CHAR(10),
	MADATCHO CHAR(10),
	SOLUONGKHACH INT,

	CONSTRAINT PK_CHITIETDATCHO
	PRIMARY KEY (SOBAN, MACHINHANH, MADATCHO)
)

CREATE TABLE NHANVIEN
(
	MANHANVIEN CHAR(10),
	HOTEN NVARCHAR(50) NOT NULL,
	NGAYSINH DATE NOT NULL,
	GIOITINH NVARCHAR(3) NOT NULL CHECK (GIOITINH IN ('NAM','NỮ')),
	SDT CHAR(10),
	EMAIL VARCHAR(100),
	DIACHI NVARCHAR(100) NOT NULL,
	CHINHANHLAMVIEC CHAR(10),
	LUONGHIENTAI FLOAT, -- Thuộc tính suy diễn từ LUONG (BOPHAN) và HESOLUONG (LICHSULAMVIEC) của công việc gần nhất
						-- LUONGHIENTAI = LUONG * HESOLUONG
	
	CONSTRAINT PK_NHANVIEN
	PRIMARY KEY (MANHANVIEN)
)

CREATE TABLE BOPHAN
(
	MABOPHAN CHAR(10),
	MACHINHANH CHAR(10),
	TENBOPHAN NVARCHAR(50) NOT NULL,
	LUONG FLOAT NOT NULL,
	QUANLYBOPHAN CHAR(10),

	CONSTRAINT PK_BOPHAN
	PRIMARY KEY (MABOPHAN, MACHINHANH)
)

CREATE TABLE LICHSULAMVIEC
(
	MANHANVIEN CHAR(10),
	MABOPHAN CHAR(10),
	MACHINHANH CHAR(10),
	NGAYVAOLAM DATE NOT NULL,
	NGAYNGHIVIEC DATE,
	HESOLUONG FLOAT NOT NULL,

	CONSTRAINT PK_LICHSULAMVIEC
	PRIMARY KEY (MANHANVIEN, MABOPHAN, MACHINHANH)
)

CREATE TABLE KHACHHANG
(
	MAKHACHHANG CHAR(10),
	HOTEN NVARCHAR(50) NOT NULL,
	SDT CHAR(10),
	EMAIL VARCHAR(100),
	CCCD VARCHAR(20) CHECK (CCCD NOT LIKE '%[^0-9]%'),

	CONSTRAINT PK_KHACHHANNG
	PRIMARY KEY (MAKHACHHANG)
)

CREATE TABLE DANHGIA
(
	MADANHGIA CHAR(10),
	DIEMPHUCVU INT NOT NULL CHECK (DIEMPHUCVU BETWEEN 1 AND 5),
	DIEMVITRICHINHANH INT NOT NULL CHECK (DIEMVITRICHINHANH BETWEEN 1 AND 5),
	DIEMKHONGGIAN INT NOT NULL CHECK (DIEMKHONGGIAN BETWEEN 1 AND 5),
	BINHLUAN NVARCHAR(MAX),
	KHACHHANGDANHGIA CHAR(10),
	CHINHANH CHAR(10) NOT NULL,
	NHANVIEN CHAR(10),
	MADON CHAR(10),

	CONSTRAINT PK_DANHGIA
	PRIMARY KEY (MADANHGIA)
)

CREATE TABLE THETHANHVIEN
(
	MATHE CHAR(10),
	LOAITHE NVARCHAR(50) NOT NULL CHECK (LOAITHE IN (N'Membership', N'Silver', N'Gold')),

	CONSTRAINT PK_THETHANHVIEN
	PRIMARY KEY (MATHE)
)

CREATE TABLE CHITIETKHACHHANG
(
	MAKHACHHANG CHAR(10),
	MATHE CHAR(10),
	NGAYDK DATE NOT NULL,
	DIEMTICHLUY INT NOT NULL CHECK (DIEMTICHLUY >= 0),
	NGAYNANGHANG DATE NOT NULL,
	TRANGTHAITAIKHOAN NVARCHAR(50) NOT NULL CHECK (TRANGTHAITAIKHOAN IN (N'Hoạt động', N'Đã xóa', N'Tạm dừng')),
	NHANVIENTAOLAP CHAR(10) NOT NULL,

	CONSTRAINT PK_CHITIETKHACHHAHG
	PRIMARY KEY (MAKHACHHANG, MATHE)
)

CREATE TABLE DANHGIAMONAN
(
	MADANHGIA CHAR(10),
	MAMON CHAR(10),
	DIEMCHATLUONGMONAN INT NOT NULL CHECK (DIEMCHATLUONGMONAN BETWEEN 1 AND 5),
	DIEMGIACA INT NOT NULL CHECK (DIEMGIACA BETWEEN 1 AND 5),

	CONSTRAINT PK_DANHGIAMONAN
	PRIMARY KEY (MADANHGIA, MAMON)
)

CREATE TABLE TRUYCAP
(
	MATRUYCAP CHAR(10),
	MADANHGIA CHAR(10),
	THOIDIEMBATDAU DATE NOT NULL,
	THOIDIEMKETTHUC DATE NOT NULL,

	CONSTRAINT PK_TRUYCAP
	PRIMARY KEY (MATRUYCAP, MADANHGIA)
)

CREATE TABLE MONAN
(
	MAMON CHAR(10),
	TENMON NVARCHAR(50) NOT NULL,
	GIAHIENTAI FLOAT NOT NULL,
	DANHMUC NVARCHAR(50) NOT NULL,
	TRANGTHAIPHUCVU NVARCHAR(20) NOT NULL CHECK (TRANGTHAIPHUCVU IN (N'Có phục vụ', N'Tạm hết', N'Đã ngưng bán')),

	CONSTRAINT PK_MONAN
	PRIMARY KEY (MAMON)
)

CREATE TABLE COMBOMONAN
(
	MACOMBO CHAR(10),
	TENCOMBO NVARCHAR(50) NOT NULL,
	MOTACOMBO NVARCHAR(MAX),
	DONGIACOMBO FLOAT NOT NULL,

	CONSTRAINT PK_COMBOMONAN
	PRIMARY KEY (MACOMBO)
)

CREATE TABLE CHITIETMONAN
(
	MACTMON CHAR(10),
	MAMON CHAR(10),
	MACOMBO CHAR(10),
	SOLUONG INT NOT NULL,
	GHICHU NVARCHAR(MAX),
	DONGIATONG FLOAT, -- Thuộc tính suy diễn từ SOLUONG (CHITIETMONAN) và GIAHIENTAI (MONAN)/DONGIACOMBO (COMBO)
					  -- DONGIATONG = SOLUONG * GIAHIENTAI/DONGIACOMBO
	MADONDATMON CHAR(10),

	CONSTRAINT PK_CHITIETMONAN
	PRIMARY KEY (MACTMON)
)

CREATE TABLE MONAN_COMBOMONAN
(
	MACOMBO CHAR(10),
	MAMON CHAR(10),
	SOLUONG INT NOT NULL,

	CONSTRAINT PK_MONAN_COMBOMONAN
	PRIMARY KEY (MACOMBO, MAMON)
)

CREATE TABLE KHUYENMAI
(
	MAKHUYENMAI CHAR(10),
	THONGTINKHUYENMAI NVARCHAR(MAX),
	LOAIKHUYENMAI NVARCHAR(20) NOT NULL,

	CONSTRAINT PK_KHUYENMAI
	PRIMARY KEY (MAKHUYENMAI)
)

CREATE TABLE KHUYENMAIKHACHHANG
(
	MAKHUYENMAI CHAR(10),
	TRANGTHAIDUNG BIT NOT NULL,
	MAKHACHHANG CHAR(10) NOT NULL,
	NGAYBATDAU DATE NOT NULL,
	NGAYKETTHUC DATE NOT NULL,
	GIATRITOITHIEU FLOAT NOT NULL,
	LUONGKMTIEN FLOAT NOT NULL,

	CONSTRAINT PK_KHUYENMAIKHACHHANG
	PRIMARY KEY (MAKHUYENMAI)
)

CREATE TABLE KHUYENMAITHETHANHVIEN
(
	MAKHUYENMAI CHAR(10),
	MATHE CHAR(10),
	LUONGKMPHANTRAM FLOAT NOT NULL,

	CONSTRAINT PK_KHUYENMAITHETHANHVIEN
	PRIMARY KEY (MAKHUYENMAI)
)

ALTER TABLE HOADON
ADD
	CONSTRAINT FK_HOADON_THE
	FOREIGN KEY (MAKHACHHANG)
	REFERENCES KHACHHANG(MAKHACHHANG)
	ON DELETE SET NULL,

	CONSTRAINT FK_HOADON_CHINHANH
	FOREIGN KEY (MACHINHANH)
	REFERENCES CHINHANH(MACHINHANH)
	ON DELETE SET NULL

ALTER TABLE DONDATMON
ADD
	CONSTRAINT FK_DONDATMON_HOADON
	FOREIGN KEY (HOADONLIENQUAN)
	REFERENCES HOADON(MAHOADON)
	ON DELETE SET NULL,

	CONSTRAINT FK_DONDATMON_KHACHHANG
	FOREIGN KEY (KHACHHANGDAT)
	REFERENCES KHACHHANG(MAKHACHHANG)
	ON DELETE SET NULL,

    CONSTRAINT FK_DONDATMON_DATCHO
	FOREIGN KEY (MADATCHO)
	REFERENCES DATCHO(MADATCHO)
	ON DELETE CASCADE,

    CONSTRAINT FK_DONDATMON_CHINHANH
	FOREIGN KEY (CHINHANHDAT)
	REFERENCES CHINHANH(MACHINHANH)
	ON DELETE CASCADE,

	CONSTRAINT FK_DONDATMON_NHANVIEN
	FOREIGN KEY (NHANVIENTAOLAP)
	REFERENCES NHANVIEN(MANHANVIEN)
	ON DELETE SET NULL

ALTER TABLE DATHANGTRUCTUYEN
ADD
    CONSTRAINT FK_DATHANGTRUCTUYEN_DONDATMON
    FOREIGN KEY (MADHTRUCTUYEN)
    REFERENCES DONDATMON(MADON)

ALTER TABLE DATHANGTAICHO
ADD
    CONSTRAINT FK_DATHANGTAICHO_DONDATMON
    FOREIGN KEY (MADHTAICHO)
    REFERENCES DONDATMON(MADON),

    CONSTRAINT PK_DATHANGTAICHO_BANAN
    FOREIGN KEY (SOBAN, MACHINHANH)
    REFERENCES BANAN(SOBAN, MACHINHANH)

ALTER TABLE CHITIETKHACHHANG
ADD
	CONSTRAINT FK_CHITIETKHACHHANG_KHACHHANG
	FOREIGN KEY (MAKHACHHANG)
	REFERENCES KHACHHANG(MAKHACHHANG),

	CONSTRAINT FK_CHITIETKHACHHANG_THETHANHVIEN
	FOREIGN KEY (MATHE)
	REFERENCES THETHANHVIEN(MATHE),

	CONSTRAINT FK_CHITIETKHACHHANG_NHANVIEN
	FOREIGN KEY (NHANVIENTAOLAP)
	REFERENCES NHANVIEN(MANHANVIEN)

ALTER TABLE DANHGIAMONAN
ADD
	CONSTRAINT FK_DANHGIAMONAN_DANHGIA
	FOREIGN KEY (MADANHGIA)
	REFERENCES DANHGIA(MADANHGIA),

	CONSTRAINT FK_DANHGIAMONAN_MONAN
	FOREIGN KEY (MAMON)
	REFERENCES MONAN(MAMON)

ALTER TABLE CHINHANH
ADD
	CONSTRAINT FK_CHINHANH_NHANVIENQUANLY
	FOREIGN KEY (NHANVIENQUANLY)
	REFERENCES NHANVIEN(MANHANVIEN)
	ON DELETE SET NULL

ALTER TABLE BANAN
ADD
	CONSTRAINT FK_BANAN_MACHINHANH
	FOREIGN KEY (MACHINHANH)
	REFERENCES CHINHANH(MACHINHANH)
	ON DELETE CASCADE

ALTER TABLE CHITIETDATCHO
ADD
	CONSTRAINT FK_CHITIETDATCHO_SOBAN_MACHINHANH
	FOREIGN KEY (SOBAN, MACHINHANH)
	REFERENCES BANAN(SOBAN, MACHINHANH)
	ON DELETE CASCADE,

	CONSTRAINT FK_CHITIETDATCHO_MADATCHO
	FOREIGN KEY (MADATCHO)
	REFERENCES DATCHO(MADATCHO)
	ON DELETE CASCADE

ALTER TABLE NHANVIEN
ADD
	CONSTRAINT FK_NHANVIEN_CHINHANH
	FOREIGN KEY (CHINHANHLAMVIEC)
	REFERENCES CHINHANH(MACHINHANH)
	ON DELETE NO ACTION

ALTER TABLE BOPHAN
ADD
	CONSTRAINT FK_BOPHAN_CHINHANH
	FOREIGN KEY (MACHINHANH)
	REFERENCES CHINHANH(MACHINHANH)
	ON DELETE CASCADE,

	CONSTRAINT FK_BOPHAN_NHANVIEN
	FOREIGN KEY (QUANLYBOPHAN)
	REFERENCES NHANVIEN(MANHANVIEN)
	ON DELETE SET NULL

ALTER TABLE LICHSULAMVIEC
ADD
	CONSTRAINT FK_LICHSULAMVIEC_BOPHAN
	FOREIGN KEY (MABOPHAN, MACHINHANH)
	REFERENCES BOPHAN(MABOPHAN, MACHINHANH)
	ON DELETE CASCADE,

	CONSTRAINT FK_LICHSULAMVIEC_NHANVIEN
	FOREIGN KEY (MANHANVIEN)
	REFERENCES NHANVIEN(MANHANVIEN)
	ON DELETE CASCADE

ALTER TABLE DANHGIA
ADD
	CONSTRAINT FK_DANHGIA_KHACHHANG
	FOREIGN KEY (KHACHHANGDANHGIA)
	REFERENCES KHACHHANG(MAKHACHHANG)
	ON DELETE SET NULL,

	CONSTRAINT FK_DANHGIA_CHINHANH
	FOREIGN KEY (CHINHANH)
	REFERENCES CHINHANH(MACHINHANH)
	ON DELETE CASCADE,

	CONSTRAINT FK_DANHGIA_NHANVIEN
	FOREIGN KEY (NHANVIEN)
	REFERENCES NHANVIEN(MANHANVIEN)
	ON DELETE SET NULL,

	CONSTRAINT FK_DANHGIA_DONDATMON
	FOREIGN KEY (MADON)
	REFERENCES DONDATMON(MADON)
	ON DELETE NO ACTION

ALTER TABLE DANHGIAMONAN
ADD
	CONSTRAINT FK_DANHGIAMONAN_MADANHGIA
	FOREIGN KEY (MADANHGIA)
	REFERENCES DANHGIA(MADANHGIA)
	ON DELETE CASCADE,

	CONSTRAINT FK_DANHGIAMONAN_MAMON
	FOREIGN KEY (MAMON)
	REFERENCES MONAN(MAMON)
	ON DELETE CASCADE

ALTER TABLE CHITIETMONAN
ADD
	CONSTRAINT FK_CHITIETMONAN_MAMON
	FOREIGN KEY (MAMON)
	REFERENCES MONAN(MAMON)
	ON DELETE CASCADE,

	CONSTRAINT FK_CHITIETMONAN_MACOMBO
	FOREIGN KEY (MACOMBO)
	REFERENCES COMBOMONAN(MACOMBO)
	ON DELETE CASCADE

ALTER TABLE MONAN_COMBOMONAN
ADD
	CONSTRAINT FK_MONAN_COMBOMONAN_MACOMBO
	FOREIGN KEY (MACOMBO)
	REFERENCES COMBOMONAN(MACOMBO)
	ON DELETE CASCADE,

	CONSTRAINT FK_MONAN_COMBOMONAN_MAMON
	FOREIGN KEY (MAMON)
	REFERENCES MONAN(MAMON)
	ON DELETE CASCADE

ALTER TABLE KHUYENMAIKHACHHANG
ADD
	CONSTRAINT FK_KHUYENMAIKHACHHANG_MAKHUYENMAI
	FOREIGN KEY (MAKHUYENMAI)
	REFERENCES KHUYENMAI(MAKHUYENMAI)
	ON DELETE CASCADE,

	CONSTRAINT FK_KHUYENMAIKHACHHANG_MAKHACHHANG
	FOREIGN KEY (MAKHACHHANG)
	REFERENCES KHACHHANG(MAKHACHHANG)
	ON DELETE CASCADE

ALTER TABLE KHUYENMAITHETHANHVIEN
ADD
	CONSTRAINT FK_KHUYENMAITHETHANHVIEN_MAKHUYENMAI
	FOREIGN KEY (MAKHUYENMAI)
	REFERENCES KHUYENMAI(MAKHUYENMAI)
	ON DELETE CASCADE,

	CONSTRAINT FK_KHUYENMAITHETHANHVIEN_MATHE
	FOREIGN KEY (MATHE)
	REFERENCES THETHANHVIEN(MATHE)
	ON DELETE CASCADE

ALTER TABLE TRUYCAP
ADD 
	CONSTRAINT FK_TRUYCAP_MADANHGIA
	FOREIGN KEY (MADANHGIA)
	REFERENCES DANHGIA(MADANHGIA)
	ON DELETE CASCADE
