USE SUSHIDB
GO

--A
SET STATISTICS TIME ON;
EXEC SP_CapNhatHangThe
SET STATISTICS TIME OFF;
GO
-- Chỉ mục cho các cột được sử dụng trong mệnh đề WHERE
CREATE NONCLUSTERED INDEX IDX_CHITIETKHACHHANG_NGAYNANGHANG ON CHITIETKHACHHANG(NGAYNANGHANG);

-- Chỉ mục cho các cột được sử dụng trong JOIN
CREATE NONCLUSTERED INDEX IDX_CHITIETKHACHHANG_MATHE ON CHITIETKHACHHANG(MATHE);

-- Chỉ mục cho cột MAKHACHHANG để tối ưu hóa điều kiện trong UPDATE
CREATE NONCLUSTERED INDEX IDX_CHITIETKHACHHANG_MAKHACHHANG ON CHITIETKHACHHANG(MAKHACHHANG);

-- Chỉ mục cho cột DIEMTICHLUY được sử dụng trong điều kiện IF
CREATE NONCLUSTERED INDEX IDX_CHITIETKHACHHANG_DIEMTICHLUY ON CHITIETKHACHHANG(DIEMTICHLUY);



--B
SET STATISTICS TIME ON;
EXEC SP_TaoVaCapThe 'KH00000501', N'Tran Dan Huy', '0913958295', 'danhuy@gmail.com', '059284823324', 'NV00000001'
SET STATISTICS TIME OFF;
GO

-- Chỉ mục cho cột MAKHACHHANG trong bảng KHACHHANG để kiểm tra sự tồn tại và thực hiện INSERT
CREATE NONCLUSTERED INDEX IDX_KHACHHANG_MAKHACHHANG ON KHACHHANG(MAKHACHHANG);

-- Chỉ mục cho cột NHANVIENTAOLAP trong bảng CHITIETKHACHHANG để tối ưu hóa câu lệnh UPDATE
CREATE NONCLUSTERED INDEX IDX_CHITIETKHACHHANG_NHANVIENTAOLAP ON CHITIETKHACHHANG(NHANVIENTAOLAP);


--C
SET STATISTICS TIME ON;
EXEC SP_XemDanhSachDanhGiaNhanVien;
SET STATISTICS TIME OFF;
GO
-- Tạo chỉ mục cho thuộc tính CHINHANHLAMVIEC trong bảng NHANVIEN (sử dụng trong JOIN và GROUP BY)
CREATE NONCLUSTERED INDEX IDX_NHANVIEN_CHINHANHLAMVIEC ON NHANVIEN(CHINHANHLAMVIEC);

-- Tạo chỉ mục cho thuộc tính NHANVIEN trong bảng DANHGIA (sử dụng trong JOIN)
CREATE NONCLUSTERED INDEX IDX_DANHGIA_NHANVIEN ON DANHGIA(NHANVIEN);

-- Tạo chỉ mục cho thuộc tính DIEMPHUCVU trong bảng DANHGIA (sử dụng trong AVG)
CREATE NONCLUSTERED INDEX IDX_DANHGIA_DIEMPHUCVU ON DANHGIA(DIEMPHUCVU);

-- Tạo chỉ mục cho thuộc tính DIEMVITRICHINHANH trong bảng DANHGIA (sử dụng trong AVG)
CREATE NONCLUSTERED INDEX IDX_DANHGIA_DIEMVITRICHINHANH ON DANHGIA(DIEMVITRICHINHANH);

-- Tạo chỉ mục cho thuộc tính DIEMKHONGGIAN trong bảng DANHGIA (sử dụng trong AVG)
CREATE NONCLUSTERED INDEX IDX_DANHGIA_DIEMKHONGGIAN ON DANHGIA(DIEMKHONGGIAN);

--D
SET STATISTICS TIME ON;
EXEC SP_THONGKE_CHATLUONG_MONAN @NGAYBATDAU = '2024-01-01';
SET STATISTICS TIME OFF;
GO

-- Chỉ mục cho cột NGAYDAT trong bảng DONDATMON để lọc theo ngày
CREATE NONCLUSTERED INDEX IDX_DONDATMON_NGAYDAT ON DONDATMON(NGAYDAT);



--E
SET STATISTICS TIME ON;
EXEC SP_DS_DONDATMON_HOADON_THEONGAY @ngaydat = '2024-12-17'
SET STATISTICS TIME OFF;
GO

-- Chỉ mục cho cột HOADONLIENQUAN trong bảng DONDATMON để tối ưu hóa JOIN với HOADON
CREATE NONCLUSTERED INDEX IDX_DONDATMON_HOADONLIENQUAN ON DONDATMON(HOADONLIENQUAN);



--F
SET STATISTICS TIME ON;
EXEC SP_THONGKE_XUHUONG_KHACHHANG @ngayBatDau = '2024-12-12', @ngayKetThuc = '2025-1-12', @maChiNhanh = 'CN0001'
SET STATISTICS TIME OFF;
GO



--G
SET STATISTICS TIME ON;
EXEC SP_TinhVaCapNhatTongTien 'HD00000001'
SET STATISTICS TIME OFF;
GO

SELECT * FROM HOADON WHERE MAHOADON = 'HD00000001'
GO
SELECT * FROM DONDATMON WHERE HOADONLIENQUAN = 'HD00000001'
GO

-- Chỉ mục cho bảng KHUYENMAIKHACHHANG để lọc khuyến mãi theo MAKHACHHANG
CREATE NONCLUSTERED INDEX IDX_KHUYENMAIKHACHHANG_MAKHACHHANG ON KHUYENMAIKHACHHANG (MAKHACHHANG, TRANGTHAIDUNG, NGAYBATDAU, NGAYKETTHUC, GIATRITOITHIEU, LUONGKMTIEN);

-- Chỉ mục cho bảng KHUYENMAITHETHANHVIEN để lọc khuyến mãi theo MATHE
CREATE NONCLUSTERED INDEX IDX_KHUYENMAITHETHANHVIEN_MATHE ON KHUYENMAITHETHANHVIEN (MATHE, LUONGKMPHANTRAM);


--H
SET STATISTICS TIME ON;
EXEC sp_ThongKeDoanhThu 'CN00000002', '2024-01-01', '2024-11-29'
SET STATISTICS TIME OFF;
GO

--I
SET STATISTICS TIME ON;
EXEC SP_ThongKe_Top_KhachHang '2000-01-01', '2024-12-31', 5;
SET STATISTICS TIME OFF;
GO

-- Tạo chỉ mục non-clustered trên MaKhachHang trong bảng HOADON
CREATE NONCLUSTERED INDEX IX_HOADON_MaKhachHang
ON HOADON (MaKhachHang);

-- Tạo chỉ mục non-clustered trên NgayLap trong bảng HOADON
CREATE NONCLUSTERED INDEX IX_HOADON_NgayLap
ON HOADON (NgayLap);

--J
SET STATISTICS TIME ON;
EXEC SP_THONGKE_TOP_MONAN '2024-05-07', '2030-12-31', 10;
SET STATISTICS TIME OFF;
GO