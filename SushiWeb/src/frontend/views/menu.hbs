<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu for Branch {{branchId}}</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        .categories {
            display: flex;
            margin-bottom: 20px;
            gap: 10px;
        }

        .category-tab {
            padding: 10px 20px;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            color: #333;
        }

        .category-tab.active {
            background-color: #333;
            color: #fff;
        }

        .items-container {
            margin-top: 20px;
        }

        .item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .item img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            margin-right: 15px;
            border-radius: 8px;
        }

        .item-info {
            flex: 1;
        }

        .item-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .item-price {
            color: #666;
        }

        .item-status {
            color: #888;
        }

        .branch-selector {
            margin-bottom: 20px;
        }

        .branch-selector select {
            padding: 10px;
            font-size: 1rem;
            border-radius: 5px;
            border: 1px solid #ddd;
            cursor: pointer;
        }
    </style>
    <script>
        async function loadCategoryItems(branchId, category) {
            const response = await fetch(`/menu/branch/${branchId}/category/${category}`);
            const items = await response.json();

            const itemsContainer = document.querySelector('.items-container');
            itemsContainer.innerHTML = '';

            items.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'item';
                itemDiv.innerHTML = `
                    <img src="${item.IMAGE_LINK || 'placeholder.jpg'}" alt="${item.TENMON}">
                    <div class="item-info">
                        <div class="item-title">${item.TENMON}</div>
                        <div class="item-price">Price: ${item.GIAHIENTAI} VND</div>
                        <div class="item-status">Status: ${item.TRANGTHAIPHUCVU}</div>
                    </div>
                `;
                itemDiv.onclick = () => {
                    window.location.href = `/menu/branch/${branchId}/category/${category}/item/${item.MAMENU}`;
                };
                itemsContainer.appendChild(itemDiv);
            });
        }

        function setActiveCategory(category) {
            const tabs = document.querySelectorAll('.category-tab');
            tabs.forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.category === category) {
                    tab.classList.add('active');
                }
            });
        }

        async function fetchBranches() {
            try {
                const response = await fetch('/menu/branches');
                const branches = await response.json();

                const selectElement = document.querySelector('.branch-selector select');
                selectElement.innerHTML = ''; // Clear any existing options

                // Add an option for each branch
                branches.forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch.branchId;
                    option.textContent = branch.branchName;
                    selectElement.appendChild(option);
                });

                // Set the currently selected branch from the template (if any)
                selectElement.value = '{{branchId}}';
            } catch (error) {
                console.error('Error fetching branches:', error);
            }
        }

        async function switchBranch(event) {
            event.preventDefault();
            const branchId = document.querySelector('.branch-selector select').value;

            console.log("Switching to branch:", branchId); // Log branch ID

            try {
                // Send a POST request to switch the branch
                const postResponse = await fetch('/menu/switch-branch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ branchId }),
                });

                if (!postResponse.ok) {
                    alert('Error switching branch');
                    return;
                }

                console.log("Branch switched successfully");

                // Redirect to the GET route for the branch menu
                window.location.href = `/menu/branch/${branchId}`;
            } catch (error) {
                console.error("Error in switchBranch:", error);
                alert('An error occurred while switching the branch');
            }
        }
    </script>
</head>

<body>
    <h1>Menu for Branch {{branchId}}</h1>

    <div class="branch-selector">
        <label for="branchSelect">Select Branch: </label>
        <select onchange="switchBranch(event)">
            {{#each branches}}
            <option value="{{this.branchId}}" {{#if (eq this.branchId ../branchId)}}selected{{/if}}>{{this.branchName}}
            </option>
            {{/each}}
        </select>
    </div>

    <div class="categories">
        {{#each categories}}
        <div class="category-tab" data-category="{{this.categoryName}}"
            onclick="setActiveCategory('{{this.categoryName}}'); loadCategoryItems('{{../branchId}}', '{{this.categoryName}}');">
            {{this.categoryName}}
        </div>
        {{/each}}
    </div>

    <div class="items-container">
        <!-- Items will be dynamically loaded here -->
    </div>

    <script>
        // Load the first category by default
        document.addEventListener('DOMContentLoaded', () => {
            fetchBranches();
            const firstCategory = document.querySelector('.category-tab');
            if (firstCategory) {
                const branchId = '{{branchId}}';
                const category = firstCategory.dataset.category;
                setActiveCategory(category);
                loadCategoryItems(branchId, category);
            }
        });
    </script>
</body>

</html>